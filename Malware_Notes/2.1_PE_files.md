# The PE File Headers and Sections

<iframe width="560" height="315" src="https://www.youtube.com/embed/l6GjU8fm8sM" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
[Basic_structrue_of_PE](https://www.youtube.com/watch?v=l6GjU8fm8sM)
[Getting_Started_with_the_Portable_Executable_File_Format](https://www.youtube.com/watch?v=CM2Tfvxrs74)

The PE file format contains a header followed by a series of sections. The header contains metadata about the file itself. The PE header provides information to operating system on how to map the file into memory. Following the header are the actual sections of the file, each of which contains useful information. The following are the most common and interesting sections in a PE file:

- **.text** : **The .text section contains the instructions that the CPU executes. All other sections store data and supporting information.** Generally, this is the only section that can execute, and it should be the only section that includes code.

- **.data** : The .data section contains the program’s global data, which is accessible from anywhere in the program. Local data is not stored in this section, or anywhere else in the PE file.

- **.rdata** : The .rdata section typically contains the import and export information, which is the same information available from both Dependency Walker and PEview (the programs that are used to find out about export, import libraries and functions). This section can also store other read-only data used by the program. **Sometimes a file will contain an .idata and .edata section, which store the import and export information.**

- **.rsrc** : The .rsrc section includes the resources used by the executable that are not considered part of the executable, such as icons, images, menus, and strings. Strings can be stored either in the .rsrc section or in the main program, but they are often stored in the .rsrc section for multilanguage support.

- .ndata: The .ndata section contains uninitialized data.

Section names are often consistent across a compiler, but can vary across different compilers. For example, Visual Studio uses .text for executable code, but Borland Delphi uses CODE. Windows doesn’t care about the actual name since it uses other information in the PE header to determine how a section is used. Furthermore, the section names are sometimes obfuscated to make analysis more difficult. 

![[2_6.png]]

---

## PE Header Summary 
The PE header contains useful information for the malware analyst. Table 1-7 reviews the key information that can be obtained from a PE header.

![[2_7.png]]


To undrestand it better : 
[Portable Executable PE File Part 1](https://www.youtube.com/watch?v=A2kDzSoVyho&list=PLziMzyAZFGMdkRg-XWZZBjqbozpddQAX5&index=9)

[ Portable Executable PE File Part 2](https://www.youtube.com/watch?v=OE22InvnGpI&list=PLziMzyAZFGMdkRg-XWZZBjqbozpddQAX5&index=10)

[Windows MSDN ImageHlp Structures](https://learn.microsoft.com/en-us/windows/win32/debug/imagehlp-structures)
![[2_8.png]]
1 NT_HEADER :

1.2 Signature : 
	0x00004550 PE
	
1.3 FILE HEADER:
-   _Machine:_ This field mentions the type of architecture for which the PE file is written. In the above example, we can see that the architecture is i386 which means that this PE file is compatible with 32-bit Intel architecture.

-   _NumberOfSections:_ A PE file contains different sections where code, variables, and other resources are stored. This field of the IMAGE_FILE_HEADER mentions the number of sections the PE file has. In our case, the PE file has five sections. We will learn about sections later in the room.

-   _TimeDateStamp:_ This field contains the time and date of the binary compilation. 

-   _PointerToSymbolTable and NumberOfSymbols:_ These fields are not generally related to PE files. Instead, they are here due to the COFF file headers.

-   _SizeOfOptionalHeader:_ This field contains the size of the optional header, which we will learn about in the next task. In our case, the size is 224 bytes. 

-   _Characteristics:_ This is another critical field. This field mentions the different characteristics of a PE file. In our case, this field tells us that the PE file has stripped relocation information, line numbers, and local symbol information. It is an executable image and compatible with a 32-bit machine.

1.3 OPTIONAL HEADER : 
[Microsoft Documentation](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_optional_header32).

-   _Magic:_ The Magic number tells whether the PE file is a 32-bit or 64-bit application. If the value is 0x010B, it denotes a 32-bit application; if the value is 0x020B, it represents a 64-bit application. 

-   _AddressOfEntryPoint:_ This field is significant from a malware analysis/reverse-engineering point of view. This is the address from where Windows will begin execution. In other words, the first instruction to be executed is present at this address. This is a Relative Virtual Address (RVA), meaning it is at an offset relative to the base address of the image (ImageBase) once loaded into memory. For executable files, this is the starting address. For device drivers, this is the address of the initialization function. The entry point function is optional for DLLs. When no entry point is present, this member is zero.

-   BaseOfCode and BaseOfData : These are the addresses of the code and data sections, respectively, relative to ImageBase.

-   _ImageBase:_ The ImageBase is the preferred loading address of the PE file in memory. Generally, the ImageBase for .exe files is 0x00400000, which is also the case for our PE file. Since Windows can't load all PE files at this preferred address, some relocations are in order when the file is loaded in memory. These relocations are then performed relative to the ImageBase. This value is a multiple of 64K bytes. The default value for DLLs is 0x10000000. The default value for applications is 0x00400000, except on Windows CE where it is 0x00010000.

-   _Subsystem:_ This represents the Subsystem required to run the image. The Subsystem can be Windows Native, GUI (Graphical User Interface), CUI (Commandline User Interface), or some other Subsystem. The screenshot above from the pe-tree utility shows that the Subsystem is 0x0002, representing Windows GUI Subsystem. We can find the complete list in [Microsoft Documentation](https://docs.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_optional_header32).

-   _DataDirectory:_ The DataDirectory is a structure that contains import and export information of the PE file (called Import Address Table and Export Address Table). This information is handy as it gives a glimpse of what the PE file might be trying to do.

2 IMAGE_SECTION_HEADER :
-   _VirtualAddress:_ This field indicates this section's Relative Virtual Address (RVA) in the memory.

-   _VirtualSize:_ This field indicates the section's size once loaded into the memory.

-   _SizeOfRawData:_ This field represents the section size as stored on the disk before the PE file is loaded in memory.

-   _Characteristics:_ The characteristics field tells us the permissions that the section has. For example, if the section has READ permissions, WRITE permissions or EXECUTE permissions.


![[2_9.png]]


**Chap1 lab:**
<iframe width="560" height="315" src="https://www.youtube.com/embed/lwUve1VdFYs" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>

[[3_basic_dynamic_analysis|Next]]